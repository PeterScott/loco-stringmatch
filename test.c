#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <sys/mman.h>
#include <errno.h>

void kmp_table(char *needle, int16_t *T, size_t len);
int kmp_search(char *haystack, char *needle, int16_t *T, size_t needle_len, size_t haystack_len);
int kmp_search3(char *haystack, size_t haystack_len);
int kmp_search_inl(char *haystack, size_t haystack_len);

int main(void) {
  char needle[7] = {'a', 'b', 'c', 'd', 'a', 'b', 'd'};
  int16_t T[7];
  char haystack[] = "abracadabra abcdefgababcdabd vooleyfoo"; /* 21 */
  
  int i;


  char testFunc[] = {0x55, 0x48, 0x89, 0xE5, 0x53, 0x48, 0x89, 0xFA, 0x48, 0x89, 0xF1, 0x48, 0x31, 0xC0, 0x48, 0x31, 0xDB, 0xEB, 0x08, 0x48, 0xFF, 0xC3, 0x48, 0x39, 0xCB, 0x7D, 0x6F, 0x8A, 0x04, 0x1A, 0x3C, 0x61, 0x75, 0xF1, 0x48, 0xFF, 0xC3, 0x48, 0x39, 0xCB, 0x7D, 0x60, 0x8A, 0x04, 0x1A, 0x3C, 0x62, 0x75, 0xEA, 0x48, 0xFF, 0xC3, 0x48, 0x39, 0xCB, 0x7D, 0x51, 0x8A, 0x04, 0x1A, 0x3C, 0x63, 0x75, 0xDB, 0x48, 0xFF, 0xC3, 0x48, 0x39, 0xCB, 0x7D, 0x42, 0x8A, 0x04, 0x1A, 0x3C, 0x64, 0x75, 0xCC, 0x48, 0xFF, 0xC3, 0x48, 0x39, 0xCB, 0x7D, 0x33, 0x8A, 0x04, 0x1A, 0x3C, 0x61, 0x75, 0xBD, 0x48, 0xFF, 0xC3, 0x48, 0x39, 0xCB, 0x7D, 0x24, 0x8A, 0x04, 0x1A, 0x3C, 0x62, 0x75, 0xBD, 0x48, 0xFF, 0xC3, 0x48, 0x39, 0xCB, 0x7D, 0x15, 0x8A, 0x04, 0x1A, 0x3C, 0x64, 0x75, 0xBD, 0x48, 0xFF, 0xC3, 0x48, 0x39, 0xCB, 0x7D, 0x06, 0x48, 0x83, 0xEB, 0x07, 0xEB, 0x10, 0x48, 0xC7, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF, 0xEB, 0x07, 0x48, 0xC7, 0xC3, 0x2A, 0x00, 0x00, 0x00, 0x89, 0xD8, 0x5B, 0xC9, 0xC3};

  typedef int (*FuncPtr)(char *, size_t);
  FuncPtr testFuncPtr = (FuncPtr)mmap(0, 160, PROT_READ | PROT_WRITE | PROT_EXEC,
				      MAP_ANON | MAP_PRIVATE, -1, 0);
  if (testFuncPtr == MAP_FAILED) {
    printf("Map failed! errno = %i\n", errno);
    exit(1);
  }
  memmove( (void*) testFuncPtr, testFunc, 159 );

  printf("Before function.\n");
  int result = (*testFuncPtr)(haystack, strlen(haystack));
  printf("Result %d\n", result);

  


  //  kmp_table(needle, T, 7);
  int idx = kmp_search3(haystack, strlen(haystack));
  printf("idx = %i\n", idx);
  idx = kmp_search_inl(haystack, strlen(haystack));
  printf("idx = %i\n", idx);

  int j, len = strlen(haystack);
  for (j = 0; j < 1000000000; j++) idx = kmp_search_inl(haystack, len);
  //for (j = 0; j < 1000000000; j++) kmp_search3(haystack, len);

  return 0;
}
